




<div id="app">
    <el-header>配置wap首页资源位</el-header>
    <el-main class="row-submit-main">
        <el-form :model="formData" :rules="rules" ref="ruleForm" label-width="120px">
            <el-card class="wap_res" shadow="always" v-for="(item,index) in formData.wap_res" style="margin-bottom: 10px">
                <span class="badge">{{index+1}}</span>
                <el-form-item label="标题:" :rules="rules.wap_title" :prop="'wap_res.'+index+'.wap_title'">
                    <el-input v-model="item.wap_title" class="w280" maxlength="11" placeholder="请输入标题"></el-input>
                </el-form-item>
                <el-form-item label="图片" :rules="rules.wap_img" :prop="'wap_res.'+index+'.wap_img'">
                    <!-- 图片裁剪 -->
                    <hbh-imgcut v-model="item.wap_img"  @valid="valid('wap_res.'+index+'.wap_img')"></hbh-imgcut>
                </el-form-item>
                <el-form-item label="链接:" :rules="rules.wap_href" :prop="'wap_res.'+index+'.wap_href'">
                    <el-input v-model="item.wap_href" class="w280"  placeholder="请输入链接"></el-input>
                </el-form-item>
                <div class="wap_add_btn">
                    <el-button v-if="formData.wap_res.length > 1" type="danger" @click="delete_img(index)">删除</el-button>
                </div>
            </el-card>
        </el-form>

        <div class="row-submit">
            <el-card shadow="always">
                <el-button type="success" @click="add">新增</el-button>
                <el-button type="primary" @click="submitForm('ruleForm')">保存</el-button>
                <el-button type="info" class="back" @click="back"> 返回 </el-button>
            </el-card>
        </div>
    </el-main>
</div>


<script>
    var vm = new Vue({
        el: '#app',
        data(){
            return{
                formData:{
                    wap_res:[
                        {
                            wap_title:'',
                            wap_img:'',
                            wap_href:''
                        }
                    ]
                },
                add_status:false,
                rules:{
                    wap_title:[
                        { required: true, message: '请输入标题', trigger: 'blur' },
                        { min: 1, max: 11, message: '长度在 1 到 11 个字符', trigger: 'blur' },
                    ],
                    wap_href:[
                        { required: true, message: '请输入链接', trigger: 'blur' },
                    ],
                    wap_img:[
                        {required: true, message: '请上传图片',trigger: 'change'}
                    ]
                }
            }
        },
        mounted(){

        },
        watch:{
            formData:{
                handler(val){
                    if(this.add_status){
                        return;
                    }else{
                        let wap = val.wap_res;
                        for(let i =0; i<wap.length;i++){
                            this.valid('wap_res.'+i+'.wap_img')
                        }
                    }
                },
                deep:true
            }
        },
        methods:{
            add(){
                //新增
                this.add_status = true;
                let obj = {
                    wap_title:'',
                    wap_img:'',
                    wap_href:''
                }
                if(this.formData.wap_res.length < 10){
                    this.formData.wap_res.push(obj)
                }else{
                    this.$message({
                        message: '最多可添加10个',
                        type: 'warning'
                    });
                    return;
                }
            },
            delete_img(index){
                this.formData.wap_res.splice(index,1)
            },
            submitForm(formName){
                //保存
                // console.log(this.formData)
                var _this = this;
                _this.$refs[formName].validate((valid) => {
                    if (valid) {

                    } else {

                        return false;
                    }
                });
            },
            valid(name){
                this.add_status = false;
                this.$refs.ruleForm.validateField(name);
            },
            back(){
                //返回
            }
        }
    });
</script>